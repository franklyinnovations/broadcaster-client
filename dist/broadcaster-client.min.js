!function(){function a(){}function b(a,b){function c(d){if(d===a.length)return void b();a[d](function(a){if(a)return void b(a);c(d+1)})}c(0)}function c(a,b){var c=this;b||(b={}),c.mode=h,c.auth={},c.timeout=3e4,c.max_attempts=10;for(var d in b)c[d]=b[d];if(!a)throw new Error("Missing URL");var e=document.createElement("a");e.href=a,c._secure="https:"===e.protocol,c._host=e.host,c._path=e.pathname,c._callbacks={},c._listeners={},c._channels={},c._attempts=0,c._queue=[],c._ready=!1}function d(a){this.connected=!1,this.client=a,this.receive=this.receive.bind(this),this.ping=this.ping.bind(this),this.pingInterval=null,this.sendQueue=[]}function e(a){this.client=a,this.polling=!1,this.pollReq=null,this.pollSeq=0,this.poll=this.poll.bind(this)}function f(a,b){this[g]=a,b&&(this.channel=b)}var g="__type",h="auto",i="websocket",j="longpoll";c.prototype.on=function(a,b){var c=this._listeners;c[a]||(c[a]=[]),c[a].push(b)},c.prototype.off=function(a,b){var c=this._listeners;if(c[a]){b||delete c[a];var d=c[a],e=d.indexOf(b);e>-1&&d.splice(e,1)}},c.prototype._emit=function(a){var b=[].slice.call(arguments,1),c=this._listeners;if(c[a])for(var d=c[a],e=0;e<d.length;e++)d[e].apply(null,b)},c.prototype.connect=function(a){function c(b){if(b)return a(b)}function f(a){return function(b){k.subscribe(a,b)}}var k=this;k._should_disconnect=!1;var l=Object.keys(k._channels);k._callbacks.auth=function(c,d){if(c)return a(c);"authError"===d[g]?a(new Error(d.reason)):"authOk"===d[g]?(k._attempts=0,k._transport.onConnect(d),b(l.map(f),a)):a(new Error("Unexpected message"))};var m=k.mode;m===h||m===i?(k._transport=new d(k),k._transport.connect(k.auth,function(a){a&&m===h?(k._transport=new e(k),k._transport.connect(k.auth,c)):c(a)})):m===j?(k._transport=new e(k),k._transport.connect(k.auth,c)):a("Unknown client mode")},c.prototype.url=function(a){var b="ws";return a===j&&(b="http"),this._secure&&(b+="s"),b+"://"+this._host+this._path},c.prototype._call=function(a,b){var c=a[g];a.channel&&(c+="_"+a.channel),this._callbacks[c]=b,this._ready?this._transport.send(a,function(a){a&&b(a)}):this._queue.push({msg:a,cb:b})},c.prototype._receive=function(a){var b=this;if("message"!==a[g]){var c=a[g].match(/Error$/),d=a[g].replace(/Error$/,"").replace(/Ok$/,"");a.channel&&(d+="_"+a.channel),b._callbacks[d]?(b._callbacks[d](null,a),"auth"!==d&&delete b._callbacks[d]):c&&b._emit("error",a)}else b._emit("message",a.channel,a.body)},c.prototype.subscribe=function(a,b){var c=this,d=new f("subscribe",a);c._call(d,function(d,e){if(d)return b(d);if(e.channel!==a)return b(new Error("Channel mismatch"));var f=e[g];"subscribeOk"===f?(c._channels[a]=!0,b()):b(new Error("subscribeError"===f?e.reason:"Unexpected "+f))})},c.prototype.unsubscribe=function(a,b){var c=this,d=new f("unsubscribe",a);c._call(d,function(d,e){if(d)return b(d);if(e.channel!==a)return b(new Error("Channel mismatch"));var f=e[g];"unsubscribeOk"===f?(delete c._channels[a],b()):b(new Error("unsubscribeError"===f?e.reason:"Unexpected "+f))})},c.prototype._disconnected=function(){var a=this;return a._should_disconnect?void a._emit("disconnected"):(a._ready=!1,a._attempts===a.max_attempts?void a._emit("disconnected"):(a._attempts++,void a.connect(function(b){b&&setTimeout(function(){a._disconnected()},1e3*(a._attempts-1))})))},c.prototype.stopReconnect=function(){this._should_disconnect=!0},c.prototype.disconnect=function(a){this._should_disconnect=!0,this._transport.disconnect(a)},c.prototype._onready=function(){this._ready=!0;for(var a=0;a<this._queue.length;a++){var b=this._queue[a];this._call(b.msg,b.cb)}this._queue=[]},d.prototype.connect=function(a,b){var c=this;try{var d=new WebSocket(c.client.url(i));d.onmessage=c.receive,d.onopen=function(){c.connected=!0,a[g]="auth",c.send(a,function(a){if(a)return void b(a);c.client._onready()})},d.onclose=function(){c.connected&&(c.connected=!1,clearTimeout(c.pingInterval),c.pingInterval=null,c.client._disconnected())},d.onerror=function(){b(new Error("Upgrade failed"))},c.conn=d}catch(a){b(a)}},d.prototype.send=function(b,c){c||(c=a);try{this.conn.send(JSON.stringify(b)),c()}catch(a){c(a)}},d.prototype.receive=function(a){this.client._receive(JSON.parse(a.data))},d.prototype.onConnect=function(){this.pingInterval||(this.pingInterval=setInterval(this.ping,.95*this.client.timeout))},d.prototype.disconnect=function(a){this.pingInterval&&(clearTimeout(this.pingInterval),this.pingInterval=null),this.conn.close(),a()},d.prototype.ping=function(){this.send(new f("ping"))},e.prototype.connect=function(a,b){var c=this;a[g]="auth",c.send(a,function(a){if(a)return void b(a);c.client._onready()})},e.prototype.send=function(a,b){var c=this;c.token&&(a.__token=c.token);var d=new XMLHttpRequest;d.open("POST",c.client.url(j),!0),d.setRequestHeader("Content-Type","application/json"),d.addEventListener("load",function(){if(200===d.status)c.receive(JSON.parse(d.responseText)),b(null);else{var a="Bad response: "+d.status;500===d.status&&(a+=", "+d.responseText),401===d.status&&c.client.stopReconnect(),b(new Error(a))}}),d.addEventListener("error",function(){b(new Error(d.responseText))}),d.send(JSON.stringify(a))},e.prototype.receive=function(a){for(var b=0;b<a.length;b++)this.client._receive(a[b])},e.prototype.onConnect=function(a){this.token=a.__token,this.polling=!0,this.poll()},e.prototype.disconnect=function(a){this.polling=!1,this.pollReq&&this.pollReq.abort(),a()},e.prototype.poll=function(){var a=this,b=new f("poll");b.seq=this.pollSeq.toString(),this.pollReq=a.send(b,function(b){b?a.client._disconnected():a.poll()}),this.pollSeq++},this.BroadcasterClient=c}();