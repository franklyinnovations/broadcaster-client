!function(){function a(a,b){function c(d){return d===a.length?void b():void a[d](function(a){return a?void b(a):void c(d+1)})}c(0)}function b(a,b){var c=this;b||(b={}),c.mode=g,c.auth={},c.timeout=3e4,c.max_attempts=10;for(var d in b)c[d]=b[d];if(!a)throw new Error("Missing URL");var e=document.createElement("a");e.href=a,c._secure="https:"===e.protocol,c._host=e.host,c._path=e.pathname,c._callbacks={},c._listeners={},c._channels={},c._attempts=0,c._queue=[],c._ready=!1}function c(a){this.connected=!1,this.client=a,this.receive=this.receive.bind(this),this.ping=this.ping.bind(this),this.pingInterval=null,this.sendQueue=[]}function d(a){this.client=a,this.polling=!1,this.pollReq=null,this.pollSeq=0,this.poll=this.poll.bind(this)}function e(a,b){this[f]=a,b&&(this.channel=b)}var f="__type",g="auto",h="websocket",i="longpoll";b.prototype.on=function(a,b){var c=this._listeners;c[a]||(c[a]=[]),c[a].push(b)},b.prototype.off=function(a,b){var c=this._listeners;if(c[a]){b||delete c[a];var d=c[a],e=d.indexOf(b);e>-1&&d.splice(e,1)}},b.prototype._emit=function(a){var b=[].slice.call(arguments,1),c=this._listeners;if(c[a])for(var d=c[a],e=0;e<d.length;e++)d[e].apply(null,b)},b.prototype.connect=function(b){function e(a){if(a)return b(a)}function j(a){return function(b){k.subscribe(a,b)}}var k=this;k._should_disconnect=!1;var l=Object.keys(k._channels);k._callbacks.auth=function(c,d){return c?b(c):void("authError"===d[f]?b(new Error(d.reason)):"authOk"===d[f]?(k._attempts=0,k._transport.onConnect(d),a(l.map(j),b)):b(new Error("Unexpected message")))};var m=k.mode;m===g||m===h?(k._transport=new c(k),k._transport.connect(k.auth,function(a){a&&m===g?(k._transport=new d(k),k._transport.connect(k.auth,e)):e(a)})):m===i?(k._transport=new d(k),k._transport.connect(k.auth,e)):b("Unknown client mode")},b.prototype.url=function(a){var b="ws";return a===i&&(b="http"),this._secure&&(b+="s"),b+"://"+this._host+this._path},b.prototype._call=function(a,b){var c=a[f];a.channel&&(c+="_"+a.channel),this._callbacks[c]=b,this._ready?this._transport.send(a,function(a){a&&b(a)}):this._queue.push({msg:a,cb:b})},b.prototype._receive=function(a){var b=this;if("message"!==a[f]){var c=a[f].match(/Error$/),d=a[f].replace(/Error$/,"").replace(/Ok$/,"");a.channel&&(d+="_"+a.channel),b._callbacks[d]?(b._callbacks[d](null,a),"auth"!==d&&delete b._callbacks[d]):c&&b._emit("error",a)}else b._emit("message",a.channel,a.body)},b.prototype.subscribe=function(a,b){var c=this,d=new e("subscribe",a);c._call(d,function(d,e){if(d)return b(d);if(e.channel!==a)return b(new Error("Channel mismatch"));var g=e[f];"subscribeOk"===g?(c._channels[a]=!0,b()):b(new Error("subscribeError"===g?e.reason:"Unexpected "+g))})},b.prototype.unsubscribe=function(a,b){var c=this,d=new e("unsubscribe",a);c._call(d,function(d,e){if(d)return b(d);if(e.channel!==a)return b(new Error("Channel mismatch"));var g=e[f];"unsubscribeOk"===g?(delete c._channels[a],b()):b(new Error("unsubscribeError"===g?e.reason:"Unexpected "+g))})},b.prototype._disconnected=function(){var a=this;if(!a._should_disconnect){if(a._ready=!1,a._attempts===a.max_attempts)return void a._emit("disconnected");a._attempts++,a.connect(function(b){b&&setTimeout(function(){a._disconnected()},1e3*(a._attempts-1))})}},b.prototype.disconnect=function(a){this._should_disconnect=!0,this._transport.disconnect(a)},b.prototype._onready=function(){this._ready=!0;for(var a=0;a<this._queue.length;a++){var b=this._queue[a];this._call(b.msg,b.cb)}this._queue=[]},c.prototype.connect=function(a,b){var c=this;try{var d=new WebSocket(c.client.url(h));d.onmessage=c.receive,d.onopen=function(){c.connected=!0,a[f]="auth",c.send(a,function(a){return a?void b(a):void c.client._onready()})},d.onclose=function(){c.connected&&(c.connected=!1,clearTimeout(c.pingInterval),c.pingInterval=null,c.client._disconnected())},d.onerror=function(){b(new Error("Upgrade failed"))},c.conn=d}catch(a){b(a)}},c.prototype.send=function(a,b){try{this.conn.send(JSON.stringify(a))}catch(a){this.conn.onclose()}b&&b()},c.prototype.receive=function(a){this.client._receive(JSON.parse(a.data))},c.prototype.onConnect=function(){this.pingInterval||(this.pingInterval=setInterval(this.ping,.95*this.client.timeout))},c.prototype.disconnect=function(a){this.pingInterval&&(clearTimeout(this.pingInterval),this.pingInterval=null),this.conn.close(),a()},c.prototype.ping=function(){this.send(new e("ping"))},d.prototype.connect=function(a,b){var c=this;a[f]="auth",c.send(a,function(a){return a?void b(a):void c.client._onready()})},d.prototype.send=function(a,b){var c=this;c.token&&(a.__token=c.token);var d=new XMLHttpRequest;d.open("POST",c.client.url(i),!0),d.setRequestHeader("Content-Type","application/json"),d.addEventListener("load",function(){if(200===d.status)c.receive(JSON.parse(d.responseText)),b(null);else{var a="Bad response: "+d.status;500===d.status&&(a+=", "+d.responseText),b(new Error(a))}}),d.addEventListener("error",function(){b(new Error(d.responseText))}),d.send(JSON.stringify(a))},d.prototype.receive=function(a){for(var b=0;b<a.length;b++)this.client._receive(a[b])},d.prototype.onConnect=function(a){this.token=a.__token,this.polling=!0,this.poll()},d.prototype.disconnect=function(a){this.polling=!1,this.pollReq&&this.pollReq.abort(),a()},d.prototype.poll=function(){var a=this,b=new e("poll");b.seq=this.pollSeq.toString(),this.pollReq=a.send(b,function(b){b?a.client._disconnected():a.poll()}),this.pollSeq++},this.BroadcasterClient=b}();